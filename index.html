<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Particle Simulator</title>
    <style>
        body {
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: #f0f0f0;
            font-family: Arial, sans-serif;
            touch-action: none;
        }
        #container {
            display: flex;
            align-items: center;
        }
        #canvas {
            border: 1px solid #000;
            touch-action: none;
        }
        #controls {
            margin-left: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #temperatureSlider {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            width: 8px;
            height: 200px;
        }
        #temperatureValue {
            text-align: center;
            margin-top: 10px;
        }
        #joystick {
            position: absolute;
            right: 10px;
            bottom: 10px;
            width: 160px;
            height: 160px;
            border-radius: 50%;
            touch-action: none;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas" width="80" height="80"></canvas>
        <div id="controls">
            <input type="range" id="temperatureSlider" min="0.1" max="2.0" step="0.1" value="1.0">
            <div id="temperatureValue">1.0</div>
        </div>
    </div>
    <canvas id="joystick" width="160" height="160"></canvas>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Canvas и контексты
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const joystickCanvas = document.getElementById('joystick');
        const joystickCtx = joystickCanvas.getContext('2d');
        const slider = document.getElementById('temperatureSlider');
        const temperatureValue = document.getElementById('temperatureValue');

        // Параметры физики
        const particles = [];
        const N = 100;
        const boxSize = 80;
        const sigma = 4.0; // Диаметр частицы
        const radius = sigma / 2; // Радиус для отрисовки
        const epsilon = 1.0;
        const cutoff = 2.5 * sigma;
        const dt = 0.005;
        const k_B = 1.0;
        const tau = 0.1;
        let T_target = 1.0;
        let gravity = { x: 0, y: 0 };
        let joystickDragging = false;
        let joystickCenter = { x: 80, y: 80 }; // Центр джойстика

        // Инициализация частиц
        for (let i = 0; i < N; i++) {
            particles.push({
                x: Math.random() * boxSize,
                y: Math.random() * boxSize,
                vx: (Math.random() - 0.5) * 2,
                vy: (Math.random() - 0.5) * 2,
                mass: 1.0,
                fx: 0,
                fy: 0
            });
        }
        console.log(`Initialized ${particles.length} particles`);

        // Обновление температуры
        slider.addEventListener('input', () => {
            T_target = parseFloat(slider.value);
            temperatureValue.textContent = T_target.toFixed(1);
            console.log(`Temperature set to ${T_target}`);
        });

        // Расчет расстояния с периодическими границами
        function distance(p1, p2) {
            let dx = p2.x - p1.x;
            let dy = p2.y - p1.y;
            dx -= boxSize * Math.round(dx / boxSize);
            dy -= boxSize * Math.round(dy / boxSize);
            return Math.sqrt(dx * dx + dy * dy);
        }

        // Сила Леннард-Джонса
        function lj_force(r) {
            if (r > cutoff || r < 0.01) return 0;
            let r6 = Math.pow(sigma / r, 6);
            let r12 = r6 * r6;
            return 24 * epsilon * (2 * r12 - r6) / r;
        }

        // Вычисление сил
        function computeForces() {
            particles.forEach(p => {
                p.fx = gravity.x * p.mass;
                p.fy = gravity.y * p.mass;
            });
            for (let i = 0; i < particles.length; i++) {
                for (let j = i + 1; j < particles.length; j++) {
                    let p1 = particles[i];
                    let p2 = particles[j];
                    let dx = p2.x - p1.x;
                    let dy = p2.y - p1.y;
                    dx -= boxSize * Math.round(dx / boxSize);
                    dy -= boxSize * Math.round(dy / boxSize);
                    let r = Math.sqrt(dx * dx + dy * dy);
                    if (r < cutoff) {
                        let force = lj_force(r);
                        let fx = force * (dx / r);
                        let fy = force * (dy / r);
                        p1.fx += fx;
                        p1.fy += fy;
                        p2.fx -= fx;
                        p2.fy -= fy;
                    }
                }
            }
        }

        // Velocity Verlet
        function velocityVerlet() {
            particles.forEach(p => {
                p.vx += 0.5 * p.fx / p.mass * dt;
                p.vy += 0.5 * p.fy / p.mass * dt;
                p.x += p.vx * dt;
                p.y += p.vy * dt;
                p.x = (p.x + boxSize) % boxSize;
                p.y = (p.y + boxSize) % boxSize;
            });
            computeForces();
            particles.forEach(p => {
                p.vx += 0.5 * p.fx / p.mass * dt;
                p.vy += 0.5 * p.fy / p.mass * dt;
            });
        }

        // Термостат Berendsen
        function berendsenThermostat() {
            let T_current = computeTemperature();
            let lambda_scale = Math.sqrt(1 + (dt / tau) * (T_target / T_current - 1));
            particles.forEach(p => {
                p.vx *= lambda_scale;
                p.vy *= lambda_scale;
            });
        }

        // Вычисление температуры
        function computeTemperature() {
            let E_kin = 0;
            particles.forEach(p => {
                E_kin += 0.5 * p.mass * (p.vx * p.vx + p.vy * p.vy);
            });
            return (2 * E_kin) / (2 * particles.length * k_B);
        }

        // Отрисовка джойстика
        function drawJoystick() {
            joystickCtx.clearRect(0, 0, joystickCanvas.width, joystickCanvas.height);
            // Круг джойстика
            joystickCtx.beginPath();
            joystickCtx.arc(80, 80, 80, 0, Math.PI * 2);
            joystickCtx.fillStyle = '#ccc';
            joystickCtx.fill();
            joystickCtx.closePath();
            // Линия при перетаскивании
            if (joystickDragging) {
                joystickCtx.beginPath();
                joystickCtx.moveTo(80, 80);
                let dx = gravity.x * 800; // Масштабируем для визуализации
                let dy = gravity.y * 800;
                let mag = Math.sqrt(dx * dx + dy * dy);
                if (mag > 80) {
                    dx = (dx / mag) * 80;
                    dy = (dy / mag) * 80;
                }
                joystickCtx.lineTo(80 + dx, 80 + dy);
                joystickCtx.strokeStyle = 'black';
                joystickCtx.lineWidth = 2;
                joystickCtx.stroke();
                joystickCtx.closePath();
            }
        }

        // Обновление и отрисовка
        function update() {
            // Физика
            velocityVerlet();
            berendsenThermostat();

            // Отрисовка частиц
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'gray';
            ctx.fillRect(0, 0, boxSize, boxSize);
            particles.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, radius, 0, Math.PI * 2);
                ctx.fillStyle = 'blue';
                ctx.fill();
                ctx.closePath();
            });

            // Отрисовка джойстика
            drawJoystick();

            requestAnimationFrame(update);
        }

        // Обработка тач-событий
        joystickCanvas.addEventListener('touchstart', e => {
            e.preventDefault();
            let rect = joystickCanvas.getBoundingClientRect();
            let touch = e.touches[0];
            let x = touch.clientX - rect.left;
            let y = touch.clientY - rect.top;
            let d = Math.sqrt((x - joystickCenter.x) ** 2 + (y - joystickCenter.y) ** 2);
            if (d < 80) {
                joystickDragging = true;
                console.log(`Joystick touched at x=${x}, y=${y}`);
            }
        });

        joystickCanvas.addEventListener('touchmove', e => {
            e.preventDefault();
            if (joystickDragging) {
                let rect = joystickCanvas.getBoundingClientRect();
                let touch = e.touches[0];
                let x = touch.clientX - rect.left;
                let y = touch.clientY - rect.top;
                let dx = x - joystickCenter.x;
                let dy = y - joystickCenter.y;
                let mag = Math.sqrt(dx * dx + dy * dy);
                if (mag > 80) {
                    dx = (dx / mag) * 80;
                    dy = (dy / mag) * 80;
                }
                gravity.x = dx * 0.1;
                gravity.y = dy * 0.1;
                console.log(`Joystick moved: gravity x=${gravity.x}, y=${gravity.y}`);
            }
        });

        joystickCanvas.addEventListener('touchend', e => {
            e.preventDefault();
            joystickDragging = false;
            console.log('Joystick released');
        });

        // Инициализация Telegram Web App
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            console.log('Telegram Web App initialized');
        } else {
            console.warn('Telegram Web App not available');
        }

        // Старт
        console.log('Starting simulation');
        update();
    </script>
</body>
</html>
